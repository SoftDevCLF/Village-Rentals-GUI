@page "/addcategorygui"
@using System.Text.Json
@using VillageRentalsGUI.Data
@inject JsonStorageService Storage

<h1>Add New Category</h1>
<hr />
<div class="container">
	<div class="row">

		<!-- Form Section -->
		<div class="col col-md-7">
			Enter new category details:
			<p class="text-danger">* <i class="text-dark">Required</i></p>

			<!-- FORM - Inputs - Category Name -->

			<form @onsubmit="CategorySubmit">

				<div class="form-group row mb-3">
					<label class="col-sm-4 col-form-label me-3">Category Name<i class="text-danger">*</i></label>
					<div class="col-sm-4">
						<input class="form-control ms-5" @bind="newCategoryName"/> 
					</div>
				</div>

				<div>
					<button class="btn btn-primary mb-3 me-3" type="submit">Add New Category</button>
				</div>
			</form>
			<p class="@formStatusClass">@formStatus</p>
		</div>


		<!-- SIDEBAR - SUCCESS -->
		<div class="col col-md-3">
			@if (successCategoryId > 0)
			{
				<table class="table">
					<thead>
						<tr class="mb-5">
							<th class="p-3 bg-success bg-opacity-50 rounded-1 text-white fs-4 ">Category Added!</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td class="border rounded-3 mt-3 py-2 px-3">Category ID: @successCategoryId</td>
						</tr>
						<tr>
							<td class="border rounded-3 py-2 px-3">Category Name: @successCategoryName</td>
						</tr>
					</tbody>
				</table>

				<div>
					<a href="/categoryGUI"><button class="btn btn-primary mt-6">Back to Categories</button></a>
				</div>
			}
		</div>


	</div>

	<!-- Category List Table Just for Testing -->
	@*<div class="mt-4">
		<h5>Categories List</h5>
		@if (categoryList.Any())
		{
			<table class="table table-bordered table-hover">
				<thead class="table-dark">
					<tr>
						<th>ID</th>
						<th>Name</th>
						<th>Remove</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var cat in categoryList)
					{
						<tr>
							<td>@cat.CategoryId</td> <!--Remove Function-->
							</td>
						</tr>
					}
				</tbody>
			</table>
		}
		else
		{
			<p>No categories added yet.</p>
		}
	</div>
	*@

</div>

@code {

	public string newCategoryName = "";
	public int successCategoryId = 0;
	public string successCategoryName;
	public string formStatus = "";
	string formStatusClass = "text-danger"; // Red text in form status

	// List initialization
	public List<Category> categoryList = new List<Category>();

	// INITIALIZE JSON to load.
	string jsonFileName = "categories.json";
	protected override void OnInitialized()
	{
		categoryList = Storage.LoadFromJsonSync<Category>(jsonFileName);
	}

	// FORM SUBMIT Method to call AddCategory()
	public void CategorySubmit()
	{
		AddCategory();
	}

	// Add New Category METHOD
	public void AddCategory()
	{
		int newId;

		if (string.IsNullOrWhiteSpace(newCategoryName))
		{

			formStatus = "Please add a category name";
			return;
		}

		// Check if list is not empty

		if (categoryList.Count > 0)
		{
			// Find the highest existing CategoryId
			int maxId = 0;

			foreach (Category c in categoryList)
			{
				if (c.CategoryId > maxId)
				{
					maxId = c.CategoryId;
				}
			}

			newId = maxId + 10;
		}
		else
		{
			newId = 10;
		}

		// Remove extra spaces from the name
		string trimmedCategoryName = newCategoryName.Trim();

		// Create new category object
		Category newCategory = new Category(newId, trimmedCategoryName);

		// Add to the list.
		categoryList.Add(newCategory);
		Storage.SaveToJsonSync(categoryList, "categories.json");


		// Store ID and Name in object for sidebar display;
		successCategoryId = newId;
		successCategoryName = trimmedCategoryName;

		// To restart
		newCategoryName = "";
		StateHasChanged();

	}

	// Remove Category (To be migrated to the category GUI)
	public void RemoveCategory(int categoryId)
	{

		Category categoryToRemove = null;

		// Check if list is not empty
		if (categoryList.Count > 0)
		{
			// Find the category by categoryID
			foreach (Category c in categoryList)
			{
				if (c.CategoryId == categoryId)
				{
					// Put it in an objectt
					categoryToRemove = c;
					break;
				}
			}


			// If there is an object inside do this.
			if (categoryToRemove != null)
			{
				categoryList.Remove(categoryToRemove);

				Storage.SaveToJsonSync(categoryList, jsonFileName);

				formStatus = $"Category {categoryToRemove.CategoryName} removed.";
			}
			// If the CATEGORIES are NOT FOUND
			else
			{
				formStatus = "Category not found.";
			}


		}

		// If there are NO CATEGORIES.
		else
		{
			formStatus = "No categories to remove.";
		}
	}

	// SAVE TO JSON (Serializer)
	private async Task SaveAsync()
	{
		Storage.SaveToJsonSync(categoryList, "categories.json");
	}

	

}

